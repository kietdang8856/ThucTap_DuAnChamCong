<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: layout (~{::body},'home','Home')}">
<head>
    <!-- Add necessary CSS and JS links here -->

    <!-- Bootstrap CSS link -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS and jQuery links -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
<section class="content-header">
    <div class="col-xs-12">
        <div class="box">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><a th:href="@{/}" th:text="${pageTitle}">.</a></h1>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
            <hr>
            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="sticky-top mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title text-center"><strong>APPOINTMENT</strong></h4>
                                    </div>
                                    <div class="card-body">
                                        <!-- Button to trigger modal -->
                                        <button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#appointmentModal">
                                            New Appointment
                                        </button>

                                        <a href="/lichlamviec/search" type="button" class="btn btn-primary btn-block">
                                            Search
                                        </a>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /.col -->
                        <div class="col-md-9">
                            <div class="card card-primary">
                                <div class="card-body p-0">
                                    <!-- THE CALENDAR -->
                                    <div id="calendar"></div>
                                </div>
                                <!-- /.card-body -->
                            </div>
                            <!-- /.card -->
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                </div><!-- /.container-fluid -->
            </section>
            <!-- /.content -->
        </div>
    </div>
    <div class="todo-overlay" id="todo-overlay">
        <!-- Your existing code for todo overlay -->
    </div>
</section>

<!-- Modal for Appointment Form -->
<div class="modal fade" id="appointmentModal" tabindex="-1" role="dialog" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentModalLabel">New Appointment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form th:action="@{/lichlamviec/save}" th:object="${lichlam}" method="post">
                    <div class="form-group">
                        <label for="tenCongViec">Appointment Name</label>
                        <input type="text" class="form-control" id="tenCongViec" th:field="*{tenCongViec}">
                    </div>

                    <div class="form-group">
                        <label for="ngayLam">Working Day</label>
                        <input type="date" class="form-control" id="ngayLam" th:field="*{ngayLam}">
                    </div>

                    <div class="form-group">
                        <label for="gioBatDau">Start Time</label>
                        <input type="time" class="form-control" id="gioBatDau" th:field="*{gioBatDau}" min="08:00" max="17:00">
                    </div>

                    <div class="form-group">
                        <label for="gioKetThuc">End Time</label>
                        <input type="time" class="form-control" id="gioKetThuc" th:field="*{gioKetThuc}" min="08:00" max="17:00">
                    </div>

                    <div class="form-group">
                        <label for="vpCongTac_id">Office</label>
                        <select class="form-control" id="vpCongTac_id" th:field="*{vpCongTac_id}">
                            <option th:each="vanphong : ${vanPhongList}" th:value="${vanphong.id}" th:text="${vanphong.tenVP}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="trangThaiLamViec_Id">Work Status</label>
                        <select class="form-control" id="trangThaiLamViec_Id" th:field="*{trangThaiLamViec_Id}">
                            <option th:each="trangthai : ${trangThaiList}" th:value="${trangthai.id}" th:text="${trangthai.tenTrangThai}"></option>
                        </select>
                    </div>

                    <!-- Move the button inside the form -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        let listLichLam = [[${listLichLam}]];
        console.log(listLichLam);
        let userList = [[${userList}]];
        var listEvent =[];

        listLichLam.forEach(function(lich){
            let fullTitle=lich.tenCongViec+
                "\n" + lich.gioBatDau + "-" +lich.gioKetThuc +
                "\n" + "TenNV: " + lich.nhanVien.tenNV +
                "\n" + "HQ Name: " +  lich.nhanVien.vpLamViecChinh.diaChi+
                "\n" + "Work Place Name: " + lich.vpCongTac.diaChi+
                "\n" + "Work type: " + lich.trangThai.tenTrangThai;
            let color;
            if(lich.trangThai.id===1){
                color="#EA4215";
            }
            if(lich.trangThai.id===2){
                color="#15BDEA";
            }
            if(lich.trangThai.id===3){
                color="#AC15EA";
            }
            if(lich.trangThai.id===4){
                color="#66c700";
            }
            console.log(color);
            var event={
                title:fullTitle ,
                start: lich.ngayLam + "T" + lich.gioBatDau,
                //end: endTime.concat(lich.ngayLam,"T",lich.gioKetThuc,":00:00"),
                end: lich.ngayLam + "T" + lich.gioKetThuc,
                allDay:false,
                display: 'block',
                backgroundColor:color,
                extendedProps: { // Thêm thông tin người dùng
                    nhanVienId: lich.nhanVien.id,
                    hoTen: lich.nhanVien.tenNV,
                    username: lich.nhanVien.username,
                    chucVu: lich.nhanVien.chucvu ? lich.nhanVien.chucvu.tenChucVu : "N/A" ,// Lấy tên chức vụ, kiểm tra null
                    noiCongTac: lich.vpCongTac.tenVP,
                    noiLamViec: lich.nhanVien.vpLamViecChinh ? lich.nhanVien.vpLamViecChinh.tenVP : "N/A"
                }
            };
            listEvent.push(event);
        });

        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {

            headerToolbar: { left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,list' }, // buttons for switching between views
            allDaySlot: false,
            slotMinTime: '08:00:00',
            slotMaxTime: '18:00:00',
            firstDay: 1,
            height: 530,
            contentHeight: 200,
            eventTimeFormat: { // like '14:30:00'
                hour: 'numeric',
                minute: '2-digit',
                meridiem: false // Ẩn ký hiệu AM/PM
            },
            views: {
                dayGridMonth: { // name of view
                    titleFormat: { year: 'numeric', month: '2-digit', day: '2-digit' }
                    // other view-specific options here
                },
                timeGridDay: { // name of view
                    titleFormat: { year: 'numeric', month: '2-digit', day: '2-digit',  hour: 'numeric', minute: '2-digit', }
                    // other view-specific options here
                },
                timeGridWeek: {
                    type: 'timeGridWeek',
                    slotDuration: '24:00:00', // Đặt khoảng thời gian của mỗi slot là 24h

                    slotLabelFormat: [
                        {
                            text: '', // Không hiển thị giờ
                        },
                        { weekday: 'short' } // Chỉ hiển thị thứ
                    ]
                }
            },
            events: listEvent,

            eventDidMount: function (info) {
                const event = info.event;
                const extendedProps = event.extendedProps;

                if (extendedProps) {
                    const tooltipContent = `
                    <div class="tooltip-content">
                        <table>
                            <tr>
                                <th>ID:</th>
                                <td>${extendedProps.nhanVienId || "N/A"}</td>
                            </tr>
                            <tr>
                                <th>Họ tên:</th>
                                <td>${extendedProps.hoTen || "N/A"}</td>
                            </tr>
                            <tr>
                                <th>Username:</th>
                                <td>${extendedProps.username || "N/A"}</td>
                            </tr>
                            <tr>
                                <th>Chức vụ:</th>
                                <td>${extendedProps.chucVu || "N/A"}</td>
                            </tr>
                              <tr>
                                <th>Nơi làm việc:</th>
                                <td>${extendedProps.noiLamViec || "N/A"}</td>
                            </tr>
                            <tr>
                                <th>Nơi công tác:</th>
                                <td>${extendedProps.noiCongTac || "N/A"}</td>
                            </tr>
                        </table>
                    </div>
                `;


                    // Tạo phần tử tooltip
                    const tooltip = document.createElement('div');
                    tooltip.classList.add('fc-tooltip');
                    tooltip.innerHTML = tooltipContent;

                    // Gắn tooltip vào phần tử sự kiện
                    info.el.appendChild(tooltip);

                    // Xử lý ẩn/hiện tooltip
                    info.el.addEventListener('mouseenter', () => {
                        tooltip.style.display = 'block';
                    });

                    info.el.addEventListener('mouseleave', () => {
                        tooltip.style.display = 'none';
                    });
                    info.el.addEventListener('mouseenter', function () {
                        // ... (Giữ nguyên phần lấy tọa độ rect)
                        const scrollY = window.scrollY || document.documentElement.scrollTop; // Lấy vị trí scroll của trang
                        const scrollX = window.scrollX || document.documentElement.scrollLeft;
                        tooltip.style.top = `${rect.top + rect.height + scrollY}px`; // Điều chỉnh vị trí tooltip
                        tooltip.style.left = `${rect.left + scrollX}px`;
                        tooltip.style.display = 'block';
                    });

                }

            }
        });
        calendar.render();
    });
</script>
</body>

</html>
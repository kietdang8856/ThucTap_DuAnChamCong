<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout (~{::body},'home','Home')}"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security6">
<head>
    <!-- Add necessary CSS and JS links here -->

    <!-- Bootstrap CSS link -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS and jQuery links -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
<section class="content-header">
    <div class="col-xs-12">
        <div class="box">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><a th:href="@{/}" th:text="${pageTitle}">.</a></h1>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
            <hr>
            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="sticky-top mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title text-center"><strong>APPOINTMENT</strong></h4>
                                    </div>
                                    <div class="card-body">
                                        <!-- Button to trigger modal -->
                                        <button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#appointmentModal">
                                            New Appointment
                                        </button>

                                        <a href="/lichlamviec/search" type="button" class="btn btn-primary btn-block">
                                            Search
                                        </a>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /.col -->
                        <div class="col-md-9">
                            <div class="card card-primary">
                                <div class="card-body p-0">
                                    <!-- THE CALENDAR -->
                                    <div id="calendar"></div>
                                    <div id="calendarModal" class="modal fade">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                    <h4 class="modal-title">Event Details</h4>

                                                </div>
                                                <div id="modalBody" class="modal-body">
                                                    <form action="#" th:action="@{/lichlamviec/update/}" th:object="${lichlam}" method="post" id="updateForm">
                                                        <div class="form-group">
                                                            <label for="tenCongViec">Appointment Name</label>
                                                            <input type="text" class="form-control" id="tenCongViec_update" value="" th:field="*{tenCongViec}">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="ngayLam">Working Day</label>
                                                            <input type="date" class="form-control" id="ngayLam_update" th:field="*{ngayLam}">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="gioBatDau">Start Time</label>
                                                            <input type="time" class="form-control" id="gioBatDau_update" th:field="*{gioBatDau}" min="08:00">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="gioKetThuc">End Time</label>
                                                            <input type="time" class="form-control" id="gioKetThuc_update" th:field="*{gioKetThuc}" min="08:00">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="vpCT_id_update">Office</label>
                                                            <select class="form-control" id="vpCT_id_update" th:field="*{vpCongTac_id}">
                                                                <option th:each="vanphong : ${vanPhongList}" th:value="${vanphong.id}" th:text="${vanphong.tenVP}"></option>
                                                            </select>
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="trangThaiLV_Id_update">Work Status</label>
                                                            <select class="form-control" id="trangThaiLV_Id_update" th:field="*{trangThaiLamViec_Id}">
                                                                <option th:each="trangthai : ${trangThaiList}"  th:value="${trangthai.id}"th:text="${trangthai.tenTrangThai}"></option>
                                                            </select>
                                                        </div>

                                                        <button type="submit" id="updateButton" class="btn btn-primary">Save</button>

                                                        <button  type="submit" class="btn btn-primary" id="updateButton">Save</button>
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
                                                    <button class="btn btn-danger" id="deleteButton">Delete</button>
                                                    <button th:href="@{/lichlamviec/delete/}" class="btn btn-danger" id="deleteButton">Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.card-body -->
                            </div>
                            <!-- /.card -->
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                </div><!-- /.container-fluid -->
            </section>
            <!-- /.content -->
        </div>
    </div>

</section>

<!-- Modal for Appointment Form -->
<div class="modal fade" id="appointmentModal" tabindex="-1" role="dialog" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentModalLabel">New Appointment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form th:action="@{/lichlamviec/save}" th:object="${lichlam}" method="post">
<!--                    <div class="form-group">-->
<!--                        <label for="tenCongViec">Appointment Name</label>-->
<!--                        <input type="text" class="form-control" id="nhanVien_id" th:field="*{nhanVien_id}">-->
<!--                    </div>-->
                    <div class="form-group">
                        <label for="tenCongViec">Appointment Name</label>
                        <input type="text" class="form-control" id="tenCongViec" th:field="*{tenCongViec}">
                    </div>

                    <div class="form-group">
                        <label for="ngayLam">Working Day</label>
                        <input type="date" class="form-control" id="ngayLam" th:field="*{ngayLam}">
                    </div>

                    <div class="form-group">
                        <label for="gioBatDau">Start Time</label>
                        <input type="time" class="form-control" id="gioBatDau" th:field="*{gioBatDau}" min="08:00" max="24:00">
                    </div>

                    <div class="form-group">
                        <label for="gioKetThuc">End Time</label>
                        <input type="time" class="form-control" id="gioKetThuc" th:field="*{gioKetThuc}" min="08:00" max="24:00">
                    </div>

                    <div class="form-group">
                        <label for="vpCongTac_id">Office</label>
                        <select class="form-control" id="vpCongTac_id" th:field="*{vpCongTac_id}">
                            <option th:each="vanphong : ${vanPhongList}" th:value="${vanphong.id}" th:text="${vanphong.tenVP}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="trangThaiLamViec_Id">Work Status</label>
                        <select class="form-control" id="trangThaiLamViec_Id" th:field="*{trangThaiLamViec_Id}">
                            <option th:each="trangthai : ${trangThaiList}" th:value="${trangthai.id}" th:text="${trangthai.tenTrangThai}"></option>
                        </select>
                    </div>

                    <!-- Move the button inside the form -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">
    var isAdmin = /*[[${isAdmin}]]*/ false;
    var currentUserId = /*[[${currentUserId}]]*/ -1;
    document.addEventListener('DOMContentLoaded', function() {
        let listLichLam = [[${listLichLam}]];
        let userId=[[${currentUserId}]]
        console.log(listLichLam);
        var listEvent =[];

        listLichLam.forEach(function(lich){
                let fullTitle= "Title:"+" " +lich.tenCongViec+
                "\n" +"Time"+" "+lich.gioBatDau + "-" +lich.gioKetThuc +
                "\n" + "Name: "+" "+ lich.nhanVien.tenNV +
                "\n" + "Head Quater name:"+" "+  lich.nhanVien.vpLamViecChinh.tenVP+
                "\n" + "Work Place Name:"+" "+ lich.vpCongTac.tenVP +
                "\n" + "Work type:"+" " + lich.trangThai.tenTrangThai;
            let color;
            if(lich.trangThai.id===1){
                color="#EA4215";
            }
            if(lich.trangThai.id===2){
                color="#15BDEA";
            }
            if(lich.trangThai.id===3){
                color="#AC15EA";
            }
            if(lich.trangThai.id===4){
                color="#53EA15";
            }
            var event={
                id:lich.id,
                tenCV:lich.tenCongViec.toString(),
                title:fullTitle ,
                start: lich.ngayLam + "T" + lich.gioBatDau,
                //end: endTime.concat(lich.ngayLam,"T",lich.gioKetThuc,":00:00"),
                end: lich.ngayLam + "T" + lich.gioKetThuc,
                allDay:false,
                display: 'block',
                backgroundColor:color,
                extendedProps: { // Thêm thông tin người dùng
                    nhanVienId: lich.nhanVien.id,
                    hoTen: lich.nhanVien.tenNV,
                    username: lich.nhanVien.username,
                    chucVu: lich.nhanVien.chucvu ? lich.nhanVien.chucvu.tenChucVu : "N/A" ,// Lấy tên chức vụ, kiểm tra null
                    noiCongTac: lich.vpCongTac.tenVP,
                    noiLamViec: lich.nhanVien.vpLamViecChinh ? lich.nhanVien.vpLamViecChinh.tenVP : "N/A",
                    //thêm thông tin ngày tháng
                    ngayLam:lich.ngayLam,
                    gioBatDau:lich.gioBatDau,
                    gioKetThuc:lich.gioKetThuc,
                    vpCongTacId:lich.vpCongTac.id,
                    trangThaiId:lich.trangThai.id,

                }
            };
            listEvent.push(event);
        });

        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {

            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,list' // Thêm chế độ xem tùy chỉnh
            }, // buttons for switching between views
            allDaySlot: false,
            slotMinTime: '08:00:00',
            slotMaxTime: '24:00:00',
            firstDay: 1,
            height: 530,
            contentHeight: 200,
            eventTimeFormat: { // like '14:30:00'
                hour: 'numeric',
                minute: '2-digit',
                meridiem: false // Ẩn ký hiệu AM/PM
            },
            views: {
                dayGridMonth: {
                    // eventContent: function (arg) {
                    //     const { event } = arg;
                    //     const { gioBatDau, gioKetThuc, hoTen, noiLamViec, noiCongTac, tenCV, trangthai } = event.extendedProps; // Lấy thêm hoTen
                    //
                    //     // Tạo event element
                    //     const eventElement = document.createElement('div');
                    //     eventElement.classList.add('fc-event', 'fc-event-main');
                    //     eventElement.style.backgroundColor = event.backgroundColor;
                    //     eventElement.dataset.bsToggle = "modal";
                    //     eventElement.dataset.bsTarget = "#calendarModal";
                    //
                    //     // Tạo div chứa nội dung sự kiện
                    //     const eventContentDiv = document.createElement('div');
                    //     eventContentDiv.classList.add('fc-event-content');
                    //
                    //     // Thêm các phần tử con vào eventContentDiv
                    //     const nameDiv = document.createElement('div');
                    //     nameDiv.classList.add('fc-event-name');
                    //     nameDiv.textContent = 'Name:' + " " + hoTen;
                    //     eventContentDiv.appendChild(nameDiv);
                    //
                    //     const tcv = document.createElement('div');
                    //     tcv.classList.add('fc-event-tcv');
                    //     tcv.textContent = 'Title:' + " " + tenCV;
                    //     eventContentDiv.appendChild(tcv);
                    //
                    //     const timeDiv = document.createElement('div');
                    //     timeDiv.classList.add('fc-event-time');
                    //     timeDiv.textContent = "Time:" + " " + `${gioBatDau} - ${gioKetThuc}`;
                    //     eventContentDiv.appendChild(timeDiv);
                    //
                    //     const nlv = document.createElement('div');
                    //     nlv.classList.add('fc-event-nlv');
                    //     nlv.textContent = "Head Quarter name:" + " " + noiLamViec;
                    //     eventContentDiv.appendChild(nlv);
                    //
                    //     const nct = document.createElement('div');
                    //     nct.classList.add('fc-event-nct');
                    //     nct.textContent = "Work Place Name:" + " " + noiCongTac;
                    //     eventContentDiv.appendChild(nct);
                    //
                    //     const tt = document.createElement('div');
                    //     tt.classList.add('fc-event-tt');
                    //     tt.textContent = "Work type:" + " " + trangthai;
                    //     eventContentDiv.appendChild(tt);
                    //
                    //     // Thêm eventContentDiv vào eventElement
                    //     eventElement.appendChild(eventContentDiv);
                    //
                    //     return { domNodes: [eventElement] };
                    // },

                },
                timeGridDay: { // name of view
                    titleFormat: { year: 'numeric', month: '2-digit', day: '2-digit',  hour: 'numeric', minute: '2-digit', }
                    // other view-specific options here
                },
                timeGridWeek:{

                }
            },

            events: listEvent,
            eventClick: function(arg) {
                console.log(arg);

                var title=arg.event._def.extendedProps.tenCV;
                var ngay=arg.event._def.extendedProps.ngayLam;
                var giobd=arg.event._def.extendedProps.gioBatDau;
                var giokt=arg.event._def.extendedProps.gioKetThuc;
                var vanPhongCTId=arg.event._def.extendedProps.vpCongTacId;
                var trangThaiId=arg.event._def.extendedProps.trangThaiId;
                var lichId=arg.event._def.publicId;
                let timeOneMinuteLater;
                const deleteButton = document.getElementById("deleteButton"); // Lấy nút Delete
                if(userId !== arg.event._def.extendedProps.nhanVienId)
                {
                    document.getElementById("deleteButton").disabled = true;
                    document.getElementById("updateButton").disabled = true;
                }
                else {
                    let date = new Date().toISOString().split('T')[0]; // Lấy ngày hiện tại (YYYY-MM-DD)
                    let time = new Date().toISOString().split('T')[1].slice(0, 5); // Lấy giờ hiện tại (HH:mm)

                    let oneMinuteLater = new Date();
                    oneMinuteLater.setMinutes(oneMinuteLater.getMinutes() + 1); // Cộng thêm 1 phút
                    timeOneMinuteLater = oneMinuteLater.toISOString().split('T')[1].slice(0, 5);

                    // So sánh ngày và thời gian của sự kiện với ngày và giờ hiện tại + 1 phút
                    if (ngay < date || (ngay === date && giobd < timeOneMinuteLater)) {
                        document.getElementById("deleteButton").disabled = true;
                        document.getElementById("updateButton").disabled = true;
                    } else {
                        document.getElementById("deleteButton").disabled = false;
                        document.getElementById("updateButton").disabled = false;
                    }

                }

                // var updateLink = '/lichlamviec/update/' + lichId;
                // $('#updateForm').attr('action', updateLink);
                // $('#updateForm input[name="id"]').val(lichId); // Đặt giá trị cho input ẩn chứa ID
                //phần update
                $('#updateButton').click(function(event) {
                    event.preventDefault(); // Ngăn chặn hành vi submit mặc định của form

                    confirmUpdate(lichId);
                });
                function confirmUpdate(lichId) {
                    Swal.fire({
                        title: 'Are you sure you want to update?',
                        text: "Your work schedule information will be updated!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Update',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Gửi request AJAX để cập nhật lịch làm việc
                            $.ajax({
                                url: '/lichlamviec/update/' + lichId,
                                type: 'POST',
                                data: $('#updateForm').serialize(), // Lấy dữ liệu từ form
                                success: function (response) {
                                    // Xử lý kết quả trả về từ server (nếu cần)
                                    Swal.fire({
                                        title: 'Success!',
                                        text: 'Work schedule has been updated.',
                                        icon: 'success'
                                    });
                                    $('#calendarModal').modal('hide'); // Đóng modal
                                    setTimeout(function() {
                                        location.reload(); // Reload trang sau 1 giây
                                    }, 1000); // 1000 milliseconds = 1 giây
                                },
                                error: function (xhr, status, error) {
                                    // Xử lý lỗi (nếu cần)
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: 'An error has occurred!',
                                    });
                                }
                            });
                        }
                    });
                }
                //phần delete
                function confirmDelete(button) {
                    Swal.fire({
                        title: 'Are you sure you want to delete?',
                        text: "You will not be able to restore this schedule!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Delete',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Thực hiện xóa lịch làm việc tại đây
                            Swal.fire({
                                title: 'Success!',
                                text: 'Work schedule has been updated.',
                                icon: 'success'
                            });
                            setTimeout(function() {
                                window.location.href = '/lichlamviec/delete/' + lichId;
                            }, 1000); // 1000 milliseconds = 1 giây

                        }
                    });
                }
                // var deleteLink = '/lichlamviec/delete/' + lichId;
                deleteButton.onclick = function() {
                    confirmDelete(this); // Gọi hàm confirmDelete khi nút được click
                };
                // $('#deleteButton input[name="id"]').val(lichId); // Đặt giá trị cho input ẩn chứa ID
                if(userId !== arg.event._def.extendedProps.nhanVienId)
                {
                    document.getElementById("deleteButton").disabled = true;
                    document.getElementById("updateButton").disabled = true;
                }
                else{
                    let date=new Date(new Date().toString().split('GMT')[0]+' UTC').toISOString().split('.')[0].slice(0,10);
                    let time=new Date(new Date().toString().split('GMT')[0]+' UTC').toISOString().split('.')[0].slice(11,19);
                    if(arg.event._def.extendedProps.ngayLam> date)
                    {
                    document.getElementById("deleteButton").disabled = false;
                    document.getElementById("updateButton").disabled = false;
                    }
                    if (arg.event._def.extendedProps.ngayLam===date
                        && arg.event._def.extendedProps.gioBatDau<time)
                    {
                        document.getElementById("deleteButton").disabled =true;
                        document.getElementById("updateButton").disabled = true;
                    }
                    else
                    {
                        document.getElementById("deleteButton").disabled =false;
                        document.getElementById("updateButton").disabled =false;
                    }

                }

                    var updateLink = '/lichlamviec/update/' + lichId;
                    $('#updateForm').attr('action', updateLink);
                    $('#updateForm input[name="id"]').val(lichId); // Đặt giá trị cho input ẩn chứa ID

                    var deleteLink = '/lichlamviec/delete/' + lichId;
                    $('#deleteButton').attr('href', deleteLink);
                    $('#tenCongViec_update').val(title);
                    $('#ngayLam_update').val(ngay);
                    $('#gioBatDau_update').val(giobd);
                    $('#gioKetThuc_update').val(giokt);
                    $('#vpCT_id_update').val(vanPhongCTId.toString());
                    $('#trangThaiLV_Id_update').val(trangThaiId.toString());

                $('#calendarModal').modal();

            },
        });
        calendar.render();
    });
</script>

<script>
    // Lấy ngày hiện tại
    var currentDate = new Date().toISOString().split('T')[0];

    // Thiết lập giá trị min của input type date
    document.getElementById("ngayLam_update").setAttribute("min", currentDate);
    document.addEventListener('DOMContentLoaded', function () {
        // ... (code của bạn)

        // Lấy các phần tử input
        const ngayLamInput = document.getElementById("ngayLam_update");
        const gioBatDauInput = document.getElementById("gioBatDau_update");
        const gioKetThucInput = document.getElementById("gioKetThuc_update");
        const tenCongViecInput = document.getElementById("tenCongViec_update");
        const submitButton = document.querySelector("#calendarModal form button[type=submit]");
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('fc-event-time');
        timeDiv.style.fontSize = 'smaller';
        eventDiv.appendChild(timeDiv);

        let isFormInvalid = false;
        // Hàm kiểm tra thời gian kết thúc
        function checkEndTime() {
            const ngayLam = ngayLamInput.value;
            const gioBatDau = gioBatDauInput.value;
            const gioKetThuc = gioKetThucInput.value;
            const tenCongViec = tenCongViecInput.value;
            if (!ngayLam || !gioBatDau || !gioKetThuc || !tenCongViec) {
                if (!isFormInvalid) { // Chỉ hiển thị thông báo lỗi một lần
                    Swal.fire({
                        icon: 'warning',
                        title: 'Attention!',
                        text: 'Please fill in the complete date and time information!',
                    });
                    isFormInvalid = true; // Đánh dấu form là không hợp lệ
                }
                submitButton.disabled = true; // Vô hiệu hóa nút Save
                return false; // Form không hợp lệ
            }
            if (ngayLam && gioBatDau && gioKetThuc) {
                const startDateTime = new Date(ngayLam + "T" + gioBatDau);
                const endDateTime = new Date(ngayLam + "T" + gioKetThuc);

                // Tạo một đối tượng Date đại diện cho 8 giờ sáng của ngày đã chọn
                const eightAM = new Date(ngayLam + "T08:00");

                if (startDateTime < eightAM || endDateTime < eightAM) {
                    submitButton.disabled = true; // Vô hiệu hóa nút Save

                    Swal.fire({
                        icon: 'error',
                        title: 'Warning!',
                        text: 'Start and end times cannot be before 8:00 AM!',
                    });

                    return false;
                }
            }
            if (ngayLam && gioBatDau && gioKetThuc) {
                const startDateTime = new Date(ngayLam + "T" + gioBatDau);
                const endDateTime = new Date(ngayLam + "T" + gioKetThuc);

                if (endDateTime <= startDateTime) {
                    submitButton.disabled = true; // Vô hiệu hóa nút Save

                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'End time must be after start time!',
                    });

                    return false;
                }
            }

            if (ngayLam && gioBatDau) {
                const now = new Date();
                const inputDateTime = new Date(ngayLam + "T" + gioBatDau);
                if (inputDateTime < now) {
                    submitButton.disabled = true;
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Start time must be after the current time!'
                    });
                    return false; // Form không hợp lệ
                }
            }

            submitButton.disabled = false;
            return true; // Form hợp lệ
        }

        // Gắn sự kiện input cho các trường thời gian
        ngayLamInput.addEventListener("input", checkEndTime);
        gioBatDauInput.addEventListener("input", checkEndTime);
        gioKetThucInput.addEventListener("input", checkEndTime);
        tenCongViecInput.addEventListener("input", checkEndTime);
    });
</script>

<script>
    // Lấy ngày hiện tại
    var currentDate = new Date().toISOString().split('T')[0];

    // Thiết lập giá trị min của input type date
    document.getElementById("ngayLam").setAttribute("min", currentDate);
    document.addEventListener('DOMContentLoaded', function () {
        // ... (code của bạn)

        // Lấy các phần tử input
        const ngayLamInput = document.getElementById("ngayLam");
        const gioBatDauInput = document.getElementById("gioBatDau");
        const gioKetThucInput = document.getElementById("gioKetThuc");
        const submitButton = document.querySelector("#appointmentModal form button[type=submit]");
        // Hàm kiểm tra thời gian kết thúc
        function checkEndTime() {
            const ngayLam = ngayLamInput.value;
            const gioBatDau = gioBatDauInput.value;
            const gioKetThuc = gioKetThucInput.value;

            if (ngayLam && gioBatDau && gioKetThuc) {
                const startDateTime = new Date(ngayLam + "T" + gioBatDau);
                const endDateTime = new Date(ngayLam + "T" + gioKetThuc);

                if (endDateTime <= startDateTime) {
                    submitButton.disabled = true; // Vô hiệu hóa nút Save

                    // Hiển thị SweetAlert2
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'End time must be after start time!',
                    });

                    return false;
                }
            }
            if (ngayLam && gioBatDau) {
                const now = new Date(); // Lấy thời gian hiện tại của client (trình duyệt)
                const inputDateTime = new Date(ngayLam + "T" + gioBatDau);
                if (inputDateTime < now) {
                    submitButton.disabled = true;
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Start time must be after the current time!'
                    });
                    return false;
                }
            }

            submitButton.disabled = false; // Kích hoạt lại nút Save
            return true;
        }

        // Gắn sự kiện input cho các trường thời gian
        ngayLamInput.addEventListener("input", checkEndTime);
        gioBatDauInput.addEventListener("input", checkEndTime);
        gioKetThucInput.addEventListener("input", checkEndTime);
    });
</script>
<script>
    var currentDate = new Date().toISOString().split('T')[0];

    // Thiết lập giá trị min của input type date
    document.getElementById("ngayLam").setAttribute("min", currentDate);
    document.addEventListener('DOMContentLoaded', function () {
        // Lấy các phần tử input
        const ngayLamInput = document.getElementById("ngayLam");
        const gioBatDauInput = document.getElementById("gioBatDau");
        const gioKetThucInput = document.getElementById("gioKetThuc");
        const tenCongViecInput = document.getElementById("tenCongViec");
        const submitButton = document.querySelector("#appointmentModal form button[type=submit]");
        let isFormInvalid = false;
        // Hàm kiểm tra thời gian kết thúc
        function checkEndTime() {
            const ngayLam = ngayLamInput.value;
            const gioBatDau = gioBatDauInput.value;
            const gioKetThuc = gioKetThucInput.value;
            const tenCongViec = tenCongViecInput.value;
            if (!ngayLam || !gioBatDau || !gioKetThuc || !tenCongViec) {
                if (!isFormInvalid) { // Chỉ hiển thị thông báo lỗi một lần
                    Swal.fire({
                        icon: 'warning',
                        title: 'Attention!',
                        text: 'Please fill in the complete date and time information!',
                    });
                    isFormInvalid = true; // Đánh dấu form là không hợp lệ
                }
                submitButton.disabled = true; // Vô hiệu hóa nút Save
                return false; // Form không hợp lệ
            }
            if (ngayLam && gioBatDau && gioKetThuc) {
                const startDateTime = new Date(ngayLam + "T" + gioBatDau);
                const endDateTime = new Date(ngayLam + "T" + gioKetThuc);

                // Tạo một đối tượng Date đại diện cho 8 giờ sáng của ngày đã chọn
                const eightAM = new Date(ngayLam + "T08:00");

                if (startDateTime < eightAM || endDateTime < eightAM) {
                    submitButton.disabled = true; // Vô hiệu hóa nút Save

                    Swal.fire({
                        icon: 'error',
                        title: 'Warning!',
                        text: 'Start and end times cannot be before 8:00 AM!',
                    });

                    return false;
                }
            }
            if (ngayLam && gioBatDau && gioKetThuc) {
                const startDateTime = new Date(ngayLam + "T" + gioBatDau);
                const endDateTime = new Date(ngayLam + "T" + gioKetThuc);

                if (endDateTime <= startDateTime) {
                    submitButton.disabled = true; // Vô hiệu hóa nút Save

                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'End time must be after start time!',
                    });

                    return false;
                }
            }

            if (ngayLam && gioBatDau) {
                const now = new Date();
                const inputDateTime = new Date(ngayLam + "T" + gioBatDau);
                if (inputDateTime < now) {
                    submitButton.disabled = true;
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Start time must be after the current time!'
                    });
                    return false; // Form không hợp lệ
                }
            }

            submitButton.disabled = false;
            return true; // Form hợp lệ
        }

        // Gắn sự kiện input cho các trường thời gian
        ngayLamInput.addEventListener("input", checkEndTime);
        gioBatDauInput.addEventListener("input", checkEndTime);
        gioKetThucInput.addEventListener("input", checkEndTime);
        tenCongViecInput.addEventListener("input", checkEndTime);
        // Gửi form khi nút "Save" được click
        submitButton.addEventListener('click', function(event) {
            event.preventDefault(); // Ngăn chặn submit mặc định

            if (checkEndTime()) { // Kiểm tra tính hợp lệ của form
                $.ajax({
                    url: '/lichlamviec/save',
                    type: 'POST',
                    data: $('#appointmentModal form').serialize(), // Lấy dữ liệu từ form
                    success: function(response) {
                        // Hiển thị SweetAlert2 khi tạo lịch thành công
                        Swal.fire({
                            title: 'Success!',
                            text: 'Work schedule has been created.',
                            icon: 'success'
                        });

                        $('#appointmentModal').modal('hide'); // Đóng modal
                        setTimeout(function() {
                            location.reload(); // Reload trang sau 1 giây
                        }, 1000); // 1000 milliseconds = 1 giây
                    },
                    error: function(xhr, status, error) {
                        if (xhr.status === 400) { // Kiểm tra lỗi validation
                            const errors = xhr.responseJSON.errors; // Lấy danh sách lỗi từ response
                            let errorMessage = "Đã có lỗi xảy ra:\n";
                            for (let i = 0; i < errors.length; i++) {
                                errorMessage += "- " + errors[i].defaultMessage + "\n";
                            }
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: errorMessage
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'An error has occurred!',
                            });
                        }
                    }
                });
            }
        });
    });
</script>

</body>

</html>